<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Home IoT Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"
        type="text/javascript"></script>
    <style>
        .card-sensor {
            border-left: 5px solid;
            transition: all 0.3s ease;
        }

        .status-on {
            border-color: #dc3545 !important;
            background-color: #f8d7da;
        }

        /* Red for Alert/On */
        .status-warn {
            border-color: #ffc107 !important;
            background-color: #fff3cd;
        }

        /* Yellow for Warning */
        .status-ok {
            border-color: #198754 !important;
            background-color: #d1e7dd;
        }

        /* Green for Normal/Off */
        .status-info {
            border-color: #0d6efd !important;
            background-color: #cff4fc;
        }

        /* Blue for Info/Knock */
        .status-na {
            border-color: #6c757d !important;
            background-color: #e2e3e5;
        }

        /* Gray for N/A */

        /* Custom styling for status badge */
        .badge-status {
            font-size: 0.9em;
            padding: 0.4em 0.7em;
        }
    </style>
</head>

<body>
    <div class="container-fluid p-4">
        <h1 class="mb-4 text-center">üè† Smart Home Sensor & API Dashboard üåç</h1>
        <div class="alert alert-info text-center" role="alert">
            **‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Broker:** ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö `test.mosquitto.org:8081` (WSS)
        </div>

        <h2 class="mt-4 mb-3 text-primary">Live Sensor Status (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏∏‡∏Å 2 ‡∏ß‡∏¥)</h2>
        <div class="row" id="sensor-cards">
            <div class="col-md-3 mb-4">
                <div class="card shadow-sm card-sensor status-na" id="card-fire">
                    <div class="card-body">
                        <h5 class="card-title">üî• ‡πÑ‡∏ü‡πÑ‡∏´‡∏°‡πâ (Flame)</h5>
                        <p class="card-text">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span class="badge badge-status bg-secondary"
                                id="fire-status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span></p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="card shadow-sm card-sensor status-na" id="card-gas">
                    <div class="card-body">
                        <h5 class="card-title">üí® ‡πÅ‡∏Å‡πä‡∏™‡∏£‡∏±‡πà‡∏ß (Gas Level)</h5>
                        <p class="card-text">‡∏Ñ‡πà‡∏≤ Analog: <strong id="gas-value">N/A</strong></p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="card shadow-sm card-sensor status-na" id="card-temp">
                    <div class="card-body">
                        <h5 class="card-title">üå°Ô∏è ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ (Temp)</h5>
                        <p class="card-text"><strong id="temp-value">N/A</strong></p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="card shadow-sm card-sensor status-na" id="card-knock">
                    <div class="card-body">
                        <h5 class="card-title">üö™ ‡∏Ñ‡∏ô‡πÄ‡∏Ñ‡∏≤‡∏∞‡∏õ‡∏£‡∏∞‡∏ï‡∏π / ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡∏±‡∏á</h5>
                        <p class="card-text">‡πÄ‡∏Ñ‡∏≤‡∏∞: <span class="badge bg-secondary" id="knock-status">‡πÑ‡∏°‡πà‡∏°‡∏µ</span></p>
                        <p class="card-text">‡πÄ‡∏™‡∏µ‡∏¢‡∏á: <span class="badge bg-secondary" id="sound-status">‡πÑ‡∏°‡πà‡∏°‡∏µ</span></p>
                    </div>
                </div>
            </div>
        </div>

        <h2 class="mt-5 mb-3 text-success">External Disaster Alerts (API Status)</h2>
        <div class="row">
            <div class="col-md-4 mb-4">
                <div class="card shadow-sm card-sensor status-na" id="card-storm">
                    <div class="card-body">
                        <h5 class="card-title">üåÄ ‡∏û‡∏≤‡∏¢‡∏∏ / ‡∏•‡∏°</h5>
                        <p class="card-text">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏•‡∏°: <strong id="wind-speed">N/A</strong></p>
                        <p class="card-text">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span class="badge badge-status bg-secondary"
                                id="storm-status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span></p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card shadow-sm card-sensor status-na" id="card-quake">
                    <div class="card-body">
                        <h5 class="card-title">üí• ‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÑ‡∏´‡∏ß</h5>
                        <p class="card-text">‡∏Ç‡∏ô‡∏≤‡∏î (Mag): <strong id="quake-mag">N/A</strong></p>
                        <p class="card-text">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span class="badge badge-status bg-secondary"
                                id="quake-status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span></p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card shadow-sm card-sensor status-na" id="card-flood">
                    <div class="card-body">
                        <h5 class="card-title">üåßÔ∏è ‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏° / ‡∏ù‡∏ô‡∏™‡∏∞‡∏™‡∏°</h5>
                        <p class="card-text">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ù‡∏ô (24h): <strong id="flood-level">N/A</strong></p>
                        <p class="card-text">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span class="badge badge-status bg-secondary"
                                id="flood-status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span></p>
                    </div>
                </div>
            </div>
        </div>

        <h2 class="mt-5 mb-3 text-warning">Data Log (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏∏‡∏Å 5 ‡∏ô‡∏≤‡∏ó‡∏µ)</h2>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Temp. (¬∞C)</th>
                        <th>Gas Value</th>
                        <th>Fire Alert</th>
                        <th>Door Knock</th>
                        <th>Wind Speed (km/h)</th>
                        <th>Quake Mag.</th>
                    </tr>
                </thead>
                <tbody id="log-table-body">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // --- 1. MQTT SETTINGS (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ Public Test Broker: test.mosquitto.org) ---
        const MQTT_HOST = "test.mosquitto.org";
        const MQTT_PORT = 8081; // Port WSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö test.mosquitto.org
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Client ID ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡πà‡∏°‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏≤‡∏£‡∏ä‡∏ô‡∏Å‡∏±‡∏ô
        const CLIENT_ID = "WebAppClient-" + Date.now() + Math.floor(Math.random() * 99999);

        // Topics
        const SENSOR_DATA_TOPIC = "iot/website/sensor_data";
        const API_DATA_TOPIC = "iot/website/api_data";
        const DOOR_KNOCK_TOPIC = "iot/door/knock_pattern";

        // Global variables for the latest data (used for 5-min logging)
        let latestSensorData = {
            temperature: 'N/A',
            gasValue: 'N/A',
            fireDetected: 'false',
            humidity: 'N/A'
        };
        // üí° ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏õ‡∏£‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• API ‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ TMD CAP keys
        let latestAPIData = {
            stormValue: 'N/A', stormStatus: 'N/A',
            quakeValue: 'N/A', quakeStatus: 'N/A',
            floodValue: 'N/A', floodStatus: 'N/A',
            fullHeadline: 'N/A'
        };
        let latestKnockStatus = '0'; // 1=knocked, 0=normal

        // --- 2. MQTT CONNECTION & MESSAGE HANDLER ---
        const client = new Paho.MQTT.Client(MQTT_HOST, MQTT_PORT, "", CLIENT_ID);

        client.onConnectionLost = onConnectionLost;
        client.onMessageArrived = onMessageArrived;

        function doConnect() {
            console.log(`Connecting to MQTT Broker via WebSocket Secure (WSS) to ${MQTT_HOST}:${MQTT_PORT}...`);
            client.connect({
                onSuccess: onConnect,
                onFailure: onFailure,
                cleanSession: true,
                useSSL: true,
                keepAliveInterval: 30
            });
        }

        function onConnect() {
            console.log("Connected to MQTT Broker successfully.");
            client.subscribe(SENSOR_DATA_TOPIC);
            client.subscribe(API_DATA_TOPIC);
            client.subscribe(DOOR_KNOCK_TOPIC);
            console.log(`Subscribed to: ${SENSOR_DATA_TOPIC}, ${API_DATA_TOPIC}, ${DOOR_KNOCK_TOPIC}`);
        }

        function onFailure(responseObject) {
            console.error("Failed to connect: " + responseObject.errorMessage);
            setTimeout(doConnect, 5000); // Retry connection
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.error("Connection lost: " + responseObject.errorMessage);
                setTimeout(doConnect, 5000); // Reconnect
            }
        }

        // Message Handler (The core of Real-time update - runs every 2s)
        function onMessageArrived(message) {
            try {
                const topic = message.destinationName;
                const payload = message.payloadString;

                if (topic === SENSOR_DATA_TOPIC) {
                    const data = JSON.parse(payload);
                    latestSensorData = data;
                    updateSensorCards(data);
                } else if (topic === API_DATA_TOPIC) {
                    const data = JSON.parse(payload);
                    latestAPIData = data;
                    updateAPICards(data); // <--- ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å
                } else if (topic === DOOR_KNOCK_TOPIC) {
                    latestKnockStatus = payload;
                    updateKnockCard(payload);
                }
            } catch (e) {
                console.error("Error parsing message:", e);
            }
        }

        // Function to update the sensor status cards (Fire, Gas, Temp)
        function updateSensorCards(data) {
            const isFire = data.fireDetected === 'true'; // Fire alert based on threshold
            const gasVal = parseInt(data.gasValue);
            const isGasAlert = gasVal > 1000; // Gas alert threshold
            const tempVal = parseFloat(data.temperature.replace('¬∞C', ''));
            const isTempAlert = tempVal > 35.0; // Temp alert threshold

            // --- Fire Card ---
            document.getElementById('fire-status').textContent = isFire ? "‡∏°‡∏µ (DETECTED)" : "‡πÑ‡∏°‡πà‡∏°‡∏µ (NORMAL)";
            document.getElementById('card-fire').className = isFire ? 'card shadow-sm card-sensor status-on' : 'card shadow-sm card-sensor status-ok';
            document.getElementById('fire-status').classList.remove('bg-secondary');
            document.getElementById('fire-status').classList.add(isFire ? 'bg-danger' : 'bg-success');

            // --- Gas Card ---
            document.getElementById('gas-value').textContent = gasVal;
            document.getElementById('card-gas').className = isGasAlert ? 'card shadow-sm card-sensor status-on' : 'card shadow-sm card-sensor status-ok';

            // --- Temp Card ---
            document.getElementById('temp-value').textContent = `${data.temperature} / ${data.humidity}`;
            document.getElementById('card-temp').className = isTempAlert ? 'card shadow-sm card-sensor status-warn' : 'card shadow-sm card-sensor status-ok';
        }

        // Function to update the door knock / sound status card
        function updateKnockCard(knockPayload) {
            const isKnock = knockPayload === '1';
            const knockBadge = document.getElementById('knock-status');
            const soundBadge = document.getElementById('sound-status');
            const knockCard = document.getElementById('card-knock');

            knockBadge.textContent = isKnock ? "‡∏°‡∏µ (DETECTED)" : "‡πÑ‡∏°‡πà‡∏°‡∏µ";
            soundBadge.textContent = isKnock ? "‡∏°‡∏µ (DETECTED)" : "‡πÑ‡∏°‡πà‡∏°‡∏µ"; // Simplified: uses same status

            const badgeClass = isKnock ? 'bg-info' : 'bg-secondary';

            knockBadge.className = 'badge ' + badgeClass;
            soundBadge.className = 'badge ' + badgeClass;

            knockCard.className = isKnock ? 'card shadow-sm card-sensor status-info' : 'card shadow-sm card-sensor status-ok';
        }

        // üí° ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: Function to update the API status cards (‡πÉ‡∏ä‡πâ TMD CAP ‡πÅ‡∏ó‡∏ô 3 ‡∏ä‡πà‡∏≠‡∏á)
        function updateAPICards(data) {
            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Severity string ‡πÄ‡∏õ‡πá‡∏ô CSS class
            function getStatusClass(severity) {
                switch (severity) {
                    case 'Extreme':
                    case 'Severe':
                        return 'status-on'; // Red/Alert
                    case 'Moderate':
                    case 'Minor':
                        return 'status-warn'; // Yellow/Warning
                    case 'Unknown':
                    case 'None':
                    case 'N/A':
                    default:
                        return 'status-ok'; // Green/Normal
                }
            }

            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Severity string ‡πÄ‡∏õ‡πá‡∏ô Badge class
            function getBadgeClass(severity) {
                switch (severity) {
                    case 'Extreme':
                    case 'Severe':
                        return 'bg-danger';
                    case 'Moderate':
                    case 'Minor':
                        return 'bg-warning';
                    case 'Unknown':
                    case 'None':
                    case 'N/A':
                    default:
                        return 'bg-success';
                }
            }

            // --- Storm Card (‡πÅ‡∏™‡∏î‡∏á Headline ‡∏û‡∏≤‡∏¢‡∏∏) ---
            const stormStatus = data.stormStatus;
            const isStormAlert = stormStatus === 'Severe' || stormStatus === 'Moderate' || stormStatus === 'Extreme';
            document.getElementById('wind-speed').textContent = data.stormValue.replace('Headline: ', ''); // ‡πÅ‡∏™‡∏î‡∏á Headline ‡πÅ‡∏ó‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏•‡∏°
            document.getElementById('storm-status').textContent = stormStatus;

            const stormCardClass = getStatusClass(stormStatus);
            document.getElementById('card-storm').className = `card shadow-sm card-sensor ${stormCardClass}`;

            document.getElementById('storm-status').classList.remove('bg-secondary');
            document.getElementById('storm-status').className = `badge badge-status ${getBadgeClass(stormStatus)}`;


            // --- Earthquake Card (‡πÅ‡∏™‡∏î‡∏á Headline ‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÑ‡∏´‡∏ß) ---
            const quakeStatus = data.quakeStatus;
            const isQuakeAlert = quakeStatus === 'Severe' || quakeStatus === 'Moderate' || quakeStatus === 'Extreme';
            document.getElementById('quake-mag').textContent = data.quakeValue.replace('Headline: ', ''); // ‡πÅ‡∏™‡∏î‡∏á Headline ‡πÅ‡∏ó‡∏ô Magnitude
            document.getElementById('quake-status').textContent = quakeStatus;

            const quakeCardClass = getStatusClass(quakeStatus);
            document.getElementById('card-quake').className = `card shadow-sm card-sensor ${quakeCardClass}`;

            document.getElementById('quake-status').classList.remove('bg-secondary');
            document.getElementById('quake-status').className = `badge badge-status ${getBadgeClass(quakeStatus)}`;


            // --- Flood Card (‡πÅ‡∏™‡∏î‡∏á Headline ‡∏ù‡∏ô/‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°) ---
            const floodStatus = data.floodStatus;
            const isFloodAlert = floodStatus === 'Severe' || floodStatus === 'Moderate' || floodStatus === 'Extreme';
            document.getElementById('flood-level').textContent = data.floodValue.replace('Headline: ', ''); // ‡πÅ‡∏™‡∏î‡∏á Headline ‡πÅ‡∏ó‡∏ô‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ù‡∏ô
            document.getElementById('flood-status').textContent = floodStatus;

            const floodCardClass = getStatusClass(floodStatus);
            document.getElementById('card-flood').className = `card shadow-sm card-sensor ${floodCardClass}`;

            document.getElementById('flood-status').classList.remove('bg-secondary');
            document.getElementById('flood-status').className = `badge badge-status ${getBadgeClass(floodStatus)}`;
        }

        // --- 4. DATA LOGGING FUNCTION (Every 5 minutes) ---
        function logDataToTable() {
            const now = new Date();
            const timestamp = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;

            // Collect data from global variables
            const fireAlert = latestSensorData.fireDetected === 'true' ? 'Yes' : 'No';
            const doorKnock = latestKnockStatus === '1' ? 'Yes' : 'No';

            // üí° ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏Å‡∏≤‡∏£ Log ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• API
            // ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏•‡∏ö API ‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏≠‡∏Å‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ Log ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤ TMD CAP ‡πÅ‡∏ó‡∏ô
            const windLog = latestAPIData.stormStatus === 'N/A' ? 'N/A' : `[TMD] ${latestAPIData.stormStatus}`;
            const quakeLog = latestAPIData.quakeStatus === 'N/A' ? 'N/A' : `[TMD] ${latestAPIData.quakeStatus}`;

            // (‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ï‡∏≤‡∏£‡∏≤‡∏á Log ‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏à‡∏≥‡∏Å‡∏±‡∏î ‡∏à‡∏∂‡∏á‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ)
            const newRow = `
        <tr>
            <td>${timestamp}</td>
            <td>${latestSensorData.temperature.replace('¬∞C', '')}</td>
            <td>${latestSensorData.gasValue}</td>
            <td>${fireAlert}</td>
            <td>${doorKnock}</td>
            <td>${windLog}</td> 
            <td>${quakeLog}</td>
        </tr>
    `;

            // Insert new row at the top of the table
            const logTableBody = document.getElementById('log-table-body');
            logTableBody.insertAdjacentHTML('afterbegin', newRow);

            // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
            if (logTableBody.rows.length > 50) {
                logTableBody.deleteRow(logTableBody.rows.length - 1);
            }

            console.log(`[LOG] Data recorded at ${timestamp}`);
        }

        // --- 5. INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Start MQTT Connection
            doConnect();

            // 2. Set interval for 5-minute logging (300,000 ms)
            setInterval(logDataToTable, 5 * 60 * 1000);

            // Initial log to confirm system start
            logDataToTable();
        });
    </script>
</body>
</html>
